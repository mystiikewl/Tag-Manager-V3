{% extends "bulk_base.html" %}

{% block title %}Bulk Category Assignment{% endblock %}
{% block page_title %}Bulk Category Assignment{% endblock %}
{% block page_subtitle %}Select products and categories to assign or remove in bulk{% endblock %}

{% block header_actions %}
<!-- Action Buttons in Header -->
<div class="flex items-center space-x-2">
    <div class="text-xs text-gray-500 mr-2">
        <span id="selection-summary">0 products selected</span>
    </div>
    <button id="clear-selection" class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-transparent text-gray-600 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">Clear Selection</button>
    <button id="remove-categories" class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-orange-600 text-white hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled style="background-color: #ea580c !important; border: 2px solid #dc2626 !important; min-width: 120px;">
        Remove Categories
    </button>
    <button id="assign-categories" class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>
        Assign Categories
    </button>
    {{ super() }}
</div>
{% endblock %}

{% block help_content %}
<div>
    <h4 class="font-medium text-gray-900 mb-2">Bulk Assignment</h4>
    <ul class="space-y-1">
        <li>â€¢ Select multiple categories using checkboxes</li>
        <li>â€¢ Use filters to find specific products</li>
        <li>â€¢ Level colors: <span class="text-blue-600">L1=Blue</span>, <span class="text-red-600">L2=Red</span>, <span class="text-green-600">L3=Green</span></li>
    </ul>
</div>
<div>
    <h4 class="font-medium text-gray-900 mb-2">Multi-Selection</h4>
    <ul class="space-y-1">
        <li>â€¢ Select products and categories, then choose "Assign" or "Remove"</li>
        <li>â€¢ Best results when selecting categories within the same level</li>
        <li>â€¢ Confirmation required for removal operations</li>
    </ul>
</div>
{{ super() }}
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="module" src="/static/js/bulk-assign.js?version=2.1"></script>
{% endblock %}

{% block content %}
<!-- Breadcrumb Navigation (moved to top of main content) -->
<div id="category-breadcrumb" class="bg-gray-100 border-b border-gray-200 px-4 sm:px-6 lg:px-8 py-2 hidden">
    <nav class="flex items-center space-x-2">
        <span class="font-medium text-gray-600 text-sm">Selected Category:</span>
        <div id="breadcrumb-path" class="flex items-center space-x-2 text-gray-800 text-sm"></div>
    </nav>
</div>

<!-- Modern Bulk Assignment Interface -->
<div class="h-screen flex flex-col bg-gray-50 text-gray-800 font-sans">
    <!-- Main Content Area -->
    <main class="flex-1 flex min-h-0">
        <!-- Resizable Category Panel -->
        <aside id="category-panel" class="w-1/3 min-w-[300px] max-w-md bg-white border-r border-gray-200 flex flex-col flex-shrink-0 h-full">
            <!-- Category Panel Header -->
            <div class="px-4 py-3 border-b border-gray-200 bg-gray-50 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <h2 class="font-semibold text-gray-800">Category Tree</h2>
                    <div class="flex items-center space-x-3">
                        <button id="expand-all" class="text-xs font-medium text-gray-500 hover:text-red-600">Expand All</button>
                        <button id="collapse-all" class="text-xs font-medium text-gray-500 hover:text-red-600">Collapse All</button>
                        <button id="clear-category-selection" class="text-xs font-medium text-gray-500 hover:text-red-600">Clear Selection</button>
                    </div>
                </div>
                
                <!-- Category Selection Summary -->
                <div id="category-selection-summary" class="mt-2 text-xs text-gray-600 bg-blue-50 p-2 rounded-md hidden">
                    <span class="font-medium">Selected Categories:</span>
                    <div id="selected-categories-list" class="mt-1 flex flex-wrap gap-1">
                        <!-- Selected categories will appear here as small chips -->
                    </div>
                </div>
                
                <!-- Category Search -->
                <div class="mt-3 relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                         <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <input type="text" id="category-search" placeholder="Search categories..." class="w-full text-sm block border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500 pl-10 pr-4 py-2 transition-colors">
                </div>
                
                <!-- Multi-selection Help Text -->
                <div class="mt-2 text-xs text-gray-500 bg-yellow-50 p-2 rounded-md">
                    <div class="flex items-start space-x-1">
                        <svg class="w-3 h-3 text-yellow-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        <div>
                            <div>Use checkboxes to select multiple categories. Best results when selecting within the same level.</div>
                            <div class="mt-1 text-blue-600 font-medium">ðŸ’¡ Select categories + products, then choose "Assign" to add or "Remove" to delete.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Interactive Category Tree -->
            <div class="flex-1 overflow-y-auto min-h-0">
                <div id="category-tree" class="p-2">
                    <!-- Dynamic category tree will be rendered here -->
                </div>
            </div>
        </aside>

        <!-- Resize Handle -->
        <div id="resize-handle" class="w-1.5 bg-gray-200 hover:bg-red-500 cursor-col-resize transition-colors duration-200 flex-shrink-0"></div>

        <!-- Product Panel -->
        <section class="flex-1 flex flex-col bg-gray-50 min-h-0 h-full">
            <!-- Product Panel Header -->
            <div class="p-4 sm:p-6 border-b border-gray-200 bg-white flex-shrink-0">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <h2 class="font-semibold text-gray-800">Products</h2>
                    <div class="text-sm text-gray-500">
                        <span id="visible-count">0</span> of <span id="total-count">0</span> products
                    </div>
                </div>

                <!-- Advanced Filters -->
                <div class="mt-4 flex flex-col sm:flex-row items-stretch sm:items-center gap-3 sm:gap-4">
                    <!-- Product Search -->
                    <div class="flex-grow min-w-[200px] relative order-1">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                        <input type="text" id="product-search" placeholder="Search products by name..." class="w-full text-sm block border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500 pl-10 pr-4 py-2 transition-colors">
                    </div>

                    <!-- Category Filters -->
                    <div class="order-2 w-full sm:w-auto">
                        <select id="category-filter" class="text-sm py-2 px-3 block border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring-red-500 w-full sm:min-w-[180px] md:min-w-[200px] transition-colors">
                            <option value="all">All Products</option>
                            <option value="uncategorized">Uncategorized Only</option>
                            <option value="categorized">Categorized Only</option>
                            <option value="multi-category">Multiple Categories</option>
                        </select>
                    </div>

                    <!-- Batch Selection -->
                    <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-2 sm:space-y-0 sm:space-x-2 order-3 w-full sm:w-auto sm:ml-auto">
                        <button id="select-all-visible" class="px-4 py-2 text-sm font-semibold rounded-lg bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">Select Visible</button>
                        <button id="select-filtered" class="px-4 py-2 text-sm font-semibold rounded-lg bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">Select All</button>
                    </div>
                </div>
            </div>

            <!-- Product List -->
            <div class="flex-1 overflow-y-auto min-h-0">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left w-12"><input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-red-600 focus:ring-red-500"></th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Product Name</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Current Categories</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="product-list" class="bg-white divide-y divide-gray-200">
                            <!-- Products will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>
</div>

<!-- Enhanced Modals -->
<!-- Assignment Preview Modal -->
<div id="assignment-preview-modal" class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-bold text-gray-900">Assignment Preview</h3>
        </div>
        <div class="p-6 overflow-y-auto space-y-5">
            <div>
                <h4 class="font-semibold text-gray-800">Selected Category:</h4>
                <div id="preview-category" class="mt-2 text-gray-600 bg-gray-100 p-3 rounded-lg"></div>
            </div>
            <div>
                <h4 class="font-semibold text-gray-800">Products to Update:</h4>
                <div id="preview-products" class="mt-2 space-y-2 max-h-48 overflow-y-auto p-3 border rounded-lg"></div>
            </div>
            <div>
                <h4 class="font-semibold text-gray-800">Impact Summary:</h4>
                <div id="preview-impact" class="mt-2 text-sm text-gray-600"></div>
            </div>
        </div>
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
            <button id="cancel-assignment" class="px-4 py-2 text-sm font-semibold rounded-lg bg-transparent text-gray-600 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">Cancel</button>
            <button id="confirm-assignment" class="px-4 py-2 text-sm font-semibold rounded-lg bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Confirm Assignment</button>
        </div>
    </div>
</div>

<!-- Progress Modal -->
<div id="progress-modal" class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto"></div>
        <h3 class="mt-4 text-lg font-semibold text-gray-900">Processing Assignment</h3>
        <p class="mt-2 text-gray-500">
            <span id="progress-text">Updating products...</span>
        </p>
        <div class="mt-4 w-full bg-gray-200 rounded-full h-2.5">
            <div id="progress-bar" class="bg-red-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <p class="mt-2 text-sm text-gray-500">
            <span id="progress-count">0</span> of <span id="progress-total">0</span> completed
        </p>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 flex items-center gap-4">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-red-600"></div>
        <p class="text-gray-800 font-medium">Loading...</p>
    </div>
</div>

<!-- Notifications -->
<div id="notification-container" class="fixed bottom-5 right-5 max-w-sm space-y-3 z-[60] pointer-events-none">
    <!-- Success and error messages will appear here -->
</div>

<script type="module" src="/static/js/bulk-assign.js"></script>
{% endblock %}
